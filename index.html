<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex, nofollow">
<title>PPH商談 ガントチャート</title>
<!-- Firebase JS SDK (compat) for Realtime Database -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI','Meiryo',sans-serif; background:#f5f7fa; color:#333; }

/* === Loading Overlay === */
#loading-overlay {
  position:fixed; top:0; left:0; width:100%; height:100%; background:#f5f7fa;
  display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999;
}
#loading-overlay .spinner {
  width:48px; height:48px; border:4px solid #c5cae9; border-top:4px solid #1a237e;
  border-radius:50%; animation:spin 1s linear infinite; margin-bottom:16px;
}
@keyframes spin { to { transform:rotate(360deg); } }
#loading-overlay p { font-size:14px; color:#555; }

/* === Header === */
.header { background:linear-gradient(135deg,#1a237e,#283593); color:#fff; padding:12px 24px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:200; }
.header h1 { font-size:18px; font-weight:600; }
.header .info { font-size:13px; opacity:0.85; }
.refresh-btn { background:#fff; color:#1a237e; border:none; border-radius:4px; padding:6px 14px; font-size:12px; font-weight:600; cursor:pointer; margin-left:12px; transition:all 0.2s; }
.refresh-btn:hover { background:#c5cae9; }
.refresh-btn:disabled { opacity:0.5; cursor:not-allowed; }
.refresh-btn .spin { display:inline-block; animation:spin 1s linear infinite; }
@keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

/* === Today Dashboard === */
.today-dash { background:#fff; border-bottom:2px solid #1a237e; padding:10px 24px; position:sticky; top:48px; z-index:190; }
.today-dash h2 { font-size:14px; color:#1a237e; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
.today-dash h2 .badge { background:#1a237e; color:#fff; font-size:11px; padding:2px 8px; border-radius:10px; }
.dash-toggle { cursor:pointer; font-size:12px; color:#666; margin-left:auto; user-select:none; }
.dash-toggle:hover { color:#1a237e; }
.dash-grid { display:flex; gap:12px; flex-wrap:wrap; }
.dash-card { background:#f8f9ff; border:1px solid #c5cae9; border-radius:8px; padding:10px 14px; min-width:200px; max-width:320px; flex:1; }
.dash-card h3 { font-size:12px; font-weight:700; margin-bottom:6px; display:flex; align-items:center; gap:6px; }
.dash-card h3 .icon { width:20px; height:20px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; color:#fff; font-size:10px; font-weight:700; }
.dash-card ul { list-style:none; padding:0; margin:0; }
.dash-card li { font-size:11px; padding:3px 0; border-bottom:1px solid #e8eaf6; display:flex; align-items:center; gap:6px; }
.dash-card li:last-child { border-bottom:none; }
.dash-card li .pref-tag { background:#e3f2fd; color:#1565c0; font-size:9px; padding:1px 5px; border-radius:3px; white-space:nowrap; }
.dash-card li .stage-tag { font-size:9px; padding:1px 5px; border-radius:3px; white-space:nowrap; }
.dash-card li .opp-name { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:180px; font-weight:500; }
.dash-empty { color:#9e9e9e; font-size:12px; font-style:italic; padding:8px 0; }
.dash-hidden { display:none; }

/* icon colors per event type */
.ic-survey { background:#4fc3f7; }
.ic-tmpsvy { background:#81d4fa; }
.ic-koji { background:#ff9800; }
.ic-blackout { background:#f44336; }
.ic-kanko { background:#ab47bc; }
.ic-start { background:#4caf50; }
.ic-start-tmr { background:#81c784; }
.ic-naiji { background:#607d8b; }
.ic-delivery { background:#795548; }
.ic-updated { background:#ff5722; }
/* stage tag colors */
.st00{background:#f5f5f5;color:#9e9e9e}.st01{background:#e3f2fd;color:#1565c0}.st04{background:#fff3e0;color:#e65100}
.st06{background:#e8f5e9;color:#2e7d32}.st08{background:#fff3e0;color:#e65100}.st09{background:#f3e5f5;color:#7b1fa2}

/* === Controls === */
.controls { background:#fff; padding:8px 24px; border-bottom:1px solid #e0e0e0; display:flex; gap:10px; align-items:center; flex-wrap:wrap; position:sticky; top:0; z-index:180; }
.controls label { font-size:12px; font-weight:500; color:#555; }
.controls select, .controls input { padding:4px 8px; border:1px solid #ccc; border-radius:4px; font-size:12px; }
.fc { font-size:13px; color:#1a237e; font-weight:700; margin-left:12px; }

/* Multi-select dropdown */
.ms-wrap { position:relative; display:inline-block; }
.ms-btn { padding:4px 8px; border:1px solid #ccc; border-radius:4px; font-size:12px; background:#fff; cursor:pointer; min-width:160px; text-align:left; white-space:nowrap; }
.ms-btn::after { content:'\25BC'; float:right; font-size:9px; margin-left:8px; color:#888; }
.ms-panel { position:absolute; top:100%; left:0; background:#fff; border:1px solid #ccc; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.15); z-index:300; min-width:220px; max-height:300px; overflow-y:auto; display:none; }
.ms-panel.open { display:block; }
.ms-panel label { display:flex; align-items:center; gap:6px; padding:5px 10px; font-size:12px; cursor:pointer; white-space:nowrap; }
.ms-panel label:hover { background:#e8eaf6; }
.ms-panel hr { border:none; border-top:1px solid #e0e0e0; margin:2px 0; }

/* Clickable legend filters */
.legend-item.flt { cursor:pointer; padding:3px 6px; border-radius:4px; border:2px solid transparent; transition:all 0.15s; user-select:none; }
.legend-item.flt:hover { background:#e8eaf6; }
.legend-item.flt.on { border-color:#1a237e; background:#e8eaf6; }
.legend-item.flt.off { opacity:0.35; }

/* === Gantt Table === */
.gantt-wrapper { overflow:auto; max-height:calc(100vh - 100px); position:relative; }
table { border-collapse:separate; border-spacing:0; }
th { background:#e8eaf6; padding:3px 2px; font-size:10px; font-weight:600; border:1px solid #c5cae9; white-space:nowrap; }
th.mh { background:#c5cae9; font-size:11px; text-align:center; font-weight:700; }
td { padding:2px 4px; border:1px solid #e0e0e0; font-size:11px; vertical-align:middle; }
tr:nth-child(even) td { background:#fafafa; }
/* Hover: only sticky columns get background; date cells get top/bottom border highlight */
tr:hover td:not(.dc) { background:#e8eaf6 !important; }
tr:hover td.dc { box-shadow: inset 0 2px 0 #9fa8da, inset 0 -2px 0 #9fa8da; }

/* ---- Sticky columns (11 cols: name, pref, type, tmpsvy, survey, svyck, const, stage, koji, kojick, next) ---- */
.col-name    { width:200px; min-width:200px; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; position:sticky; left:0;     background:#fff; z-index:5; border-right:1px solid #c5cae9; font-size:11px; padding:3px 6px; }
.col-pref    { width:56px;  min-width:56px;  max-width:56px;  white-space:nowrap; position:sticky; left:200px;  background:#fff; z-index:5; border-right:1px solid #c5cae9; font-size:10px; padding:2px 3px; text-align:center; }
.col-type    { width:56px;  min-width:56px;  max-width:56px;  white-space:nowrap; position:sticky; left:256px;  background:#fff; z-index:5; border-right:1px solid #c5cae9; font-size:10px; padding:2px 3px; text-align:center; }
.col-tmpsvy  { width:70px;  min-width:70px;  max-width:70px;  white-space:nowrap; position:sticky; left:312px;  background:#fff; z-index:5; border-right:1px solid #c5cae9; font-size:10px; padding:2px 3px; text-align:center; }
.col-survey  { width:56px;  min-width:56px;  max-width:56px;  white-space:nowrap; position:sticky; left:382px;  background:#fff; z-index:5; font-size:10px; padding:2px 3px; text-align:center; }
.col-svyck   { width:30px;  min-width:30px;  max-width:30px;  white-space:nowrap; position:sticky; left:438px;  background:#fff; z-index:5; border-right:1px solid #c5cae9; font-size:10px; padding:2px 1px; text-align:center; }
.col-const   { width:56px;  min-width:56px;  max-width:56px;  white-space:nowrap; overflow:hidden; text-overflow:ellipsis; position:sticky; left:468px;  background:#fff; z-index:5; border-right:1px solid #c5cae9; font-size:10px; padding:2px 3px; text-align:center; }
.col-stage   { width:110px; min-width:110px; max-width:110px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; position:sticky; left:524px;  background:#fff; z-index:5; border-right:1px solid #c5cae9; font-size:10px; padding:3px 4px; }
.col-koji    { width:56px;  min-width:56px;  max-width:56px;  white-space:nowrap; position:sticky; left:634px;  background:#fff; z-index:5; font-size:10px; padding:2px 3px; text-align:center; }
.col-kojick  { width:30px;  min-width:30px;  max-width:30px;  white-space:nowrap; position:sticky; left:690px;  background:#fff; z-index:5; border-right:1px solid #c5cae9; font-size:10px; padding:2px 1px; text-align:center; }
.col-next    { width:120px; min-width:120px; max-width:120px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; position:sticky; left:720px;  background:#fff; z-index:5; border-right:2px solid #1a237e; font-size:10px; padding:3px 4px; }
.ck-ok       { color:#2e7d32; font-weight:700; }
.ck-ng       { color:#bdbdbd; }

/* Header sticky cells: need higher z-index for both top+left */
thead th.col-name, thead th.col-pref, thead th.col-type,
thead th.col-tmpsvy, thead th.col-survey, thead th.col-svyck, thead th.col-const,
thead th.col-stage, thead th.col-koji, thead th.col-kojick, thead th.col-next { z-index:30; background:#e8eaf6; }

/* Even row backgrounds for sticky cols */
tr:nth-child(even) .col-name, tr:nth-child(even) .col-pref, tr:nth-child(even) .col-type,
tr:nth-child(even) .col-tmpsvy, tr:nth-child(even) .col-survey, tr:nth-child(even) .col-svyck, tr:nth-child(even) .col-const,
tr:nth-child(even) .col-stage, tr:nth-child(even) .col-koji, tr:nth-child(even) .col-kojick, tr:nth-child(even) .col-next { background:#fafafa; }
/* Hover for sticky cols */
tr:hover .col-name, tr:hover .col-pref, tr:hover .col-type,
tr:hover .col-tmpsvy, tr:hover .col-survey, tr:hover .col-svyck, tr:hover .col-const,
tr:hover .col-stage, tr:hover .col-koji, tr:hover .col-kojick, tr:hover .col-next { background:#e8eaf6 !important; }

/* Header row sticky top */
thead tr:first-child th { position:sticky; top:0; z-index:20; }
thead tr:nth-child(2) th { position:sticky; top:26px; z-index:20; }
/* Header sticky cols override: top + left = highest z */
thead tr:first-child th.col-name, thead tr:first-child th.col-pref, thead tr:first-child th.col-type,
thead tr:first-child th.col-tmpsvy, thead tr:first-child th.col-survey, thead tr:first-child th.col-svyck, thead tr:first-child th.col-const,
thead tr:first-child th.col-stage, thead tr:first-child th.col-koji, thead tr:first-child th.col-kojick, thead tr:first-child th.col-next { z-index:40; }

.nx-wait { color:#1565c0; font-weight:600; }
.nx-alert { background:#ffebee !important; color:#c62828; font-weight:700; }

/* Date cells */
.dc { width:24px; min-width:24px; max-width:24px; height:26px; padding:0; text-align:center; font-size:9px; }
.tl { background:rgba(255,0,0,0.15) !important; border-left:2px solid #f44336 !important; border-right:2px solid #f44336 !important; }
.dc.sat { background:#e3f2fd; }
.sat-head { background:#bbdefb !important; color:#1565c0; font-weight:700; }
.dc.sun { background:#ffebee; }
.sun-head { background:#ffcdd2 !important; color:#c62828; font-weight:700; }

.legend { display:flex; gap:12px; padding:6px 24px; background:#fff; border-top:1px solid #e0e0e0; flex-wrap:wrap; align-items:center; font-size:11px; }
.legend-item { display:flex; align-items:center; gap:3px; }
.legend-color { width:14px; height:9px; border-radius:2px; display:inline-block; }

.s00{color:#9e9e9e}.s01{color:#2196f3}.s04{color:#ff9800}.s06{color:#4caf50}.s08{color:#e65100}.s09{color:#7b1fa2}.s10{color:#1b5e20}.sl{color:#c62828}.sp{color:#795548}

/* Sort header */
th.sortable { cursor:pointer; user-select:none; }
th.sortable:hover { background:#d1d5db !important; }
th.sort-asc::after { content:' \u25b2'; font-size:8px; }
th.sort-desc::after { content:' \u25bc'; font-size:8px; }

.has-user { color:#1565c0; font-weight:600; }
.no-user { color:#bbb; }
.date-val { color:#333; font-weight:500; }
.date-empty { color:#ccc; }
</style>
</head>
<body>

<!-- Loading overlay -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <p>データを読み込み中...</p>
</div>

<div class="header">
  <h1>PPH商談 ガントチャート（進行中案件）</h1>
  <div class="info">最終更新: <span id="ut"></span> | 全データ: <span id="tc"></span>件
    <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">&#x21BB; データ更新</button>
  </div>
</div>

<!-- ===== Today Dashboard ===== -->
<div class="today-dash" id="todayDash">
  <h2>
    <span>&#x1F4C5; 本日のスケジュール</span>
    <span class="badge" id="todayCount">0件</span>
    <span class="dash-toggle" id="dashToggle" onclick="toggleDash()">&#x25BC; たたむ</span>
  </h2>
  <div class="dash-grid" id="dashGrid"></div>
</div>

<div class="controls" id="ctrlBar">
  <label>ステータス:</label>
  <div class="ms-wrap" id="sfWrap">
    <div class="ms-btn" id="sfBtn" onclick="document.getElementById('sfPanel').classList.toggle('open')">全て</div>
    <div class="ms-panel" id="sfPanel">
      <label><input type="checkbox" value="00" onchange="onStageChk()">00_潜在案件</label>
      <label><input type="checkbox" value="01" onchange="onStageChk()">01_見極め</label>
      <label><input type="checkbox" value="02" onchange="onStageChk()">02_メリット訴求</label>
      <label><input type="checkbox" value="03" onchange="onStageChk()">03_提案実施</label>
      <label><input type="checkbox" value="04" onchange="onStageChk()">04_意思決定者の賛同</label>
      <label><input type="checkbox" value="05" onchange="onStageChk()">05_リスク排除</label>
      <label><input type="checkbox" value="06" onchange="onStageChk()">06_内示</label>
      <label><input type="checkbox" value="07" onchange="onStageChk()">07_契約締結</label>
      <label><input type="checkbox" value="08" onchange="onStageChk()">08_施工中</label>
      <label><input type="checkbox" value="09" onchange="onStageChk()">09_完工検査</label>
    </div>
  </div>
  <label>都道府県:</label>
  <select id="pff" onchange="render()"><option value="all" selected>全て</option></select>
  <label>事業区分:</label>
  <div class="ms-wrap" id="ctWrap">
    <div class="ms-btn" id="ctBtn" onclick="document.getElementById('ctPanel').classList.toggle('open')">全て</div>
    <div class="ms-panel" id="ctPanel"></div>
  </div>
  <label>施工担当:</label>
  <select id="cuf" onchange="render()">
    <option value="all" selected>全て</option><option value="none">未設定</option>
  </select>
  <label>検索:</label>
  <input type="text" id="si" placeholder="商談名..." style="width:140px;" oninput="render()">
  <label>期間:</label>
  <select id="pf" onchange="render()">
    <option value="3">3ヶ月</option><option value="6" selected>6ヶ月</option>
    <option value="12">12ヶ月</option><option value="all">全期間</option>
  </select>
  <span class="fc" id="fc"></span>
</div>
<div class="legend" id="legendBar">
  <span style="font-size:10px;color:#888;margin-right:2px;">▼絞込:</span>
  <div class="legend-item flt" data-ev="naiji" onclick="toggleEv(this)"><div class="legend-color" style="background:#607d8b"></div>内示</div>
  <div class="legend-item flt" data-ev="tmpsvy" onclick="toggleEv(this)"><div class="legend-color" style="background:#b3e5fc;border:1px solid #4fc3f7"></div>仮現調</div>
  <div class="legend-item flt" data-ev="survey" onclick="toggleEv(this)"><div class="legend-color" style="background:#4fc3f7"></div>本現調</div>
  <div class="legend-item flt" data-ev="delivery" onclick="toggleEv(this)"><div class="legend-color" style="background:#795548"></div>納品</div>
  <div class="legend-item flt" data-ev="koji" onclick="toggleEv(this)"><div class="legend-color" style="background:#ff9800"></div>着工〜完工</div>
  <div class="legend-item flt" data-ev="blackout" onclick="toggleEv(this)"><div class="legend-color" style="background:#f44336"></div>停電</div>
  <div class="legend-item flt" data-ev="kanko" onclick="toggleEv(this)"><div class="legend-color" style="background:#ab47bc"></div>完工検査</div>
  <div class="legend-item flt" data-ev="start" onclick="toggleEv(this)"><div class="legend-color" style="background:#4caf50"></div>稼働開始</div>
  <div class="legend-item" style="border-left:1px solid #ccc;padding-left:10px;margin-left:6px;">
    ■確定 / <span style="opacity:0.5;">□予定</span>
  </div>
  <div class="legend-item" style="border-left:1px solid #ccc;padding-left:10px;margin-left:6px;">
    <div class="legend-color" style="background:#bbdefb;border:1px solid #90caf9"></div><span style="color:#1565c0;font-weight:600;">土</span>
    <div class="legend-color" style="background:#ffcdd2;border:1px solid #ef9a9a;margin-left:6px;"></div><span style="color:#c62828;font-weight:600;">日祝</span>
  </div>
</div>
<div class="gantt-wrapper" id="gw">
  <table id="gt"></table>
</div>

<script>
// Firebase Realtime Database URL
// ===== Firebase 初期化 (ガイド Section 4 相当) =====
const FIREBASE_DB_URL = 'https://pph-gantt-chart-default-rtdb.asia-southeast1.firebasedatabase.app';
firebase.initializeApp({ databaseURL: FIREBASE_DB_URL });
const fbDb = firebase.database();

let D = [];
const NOW = new Date(); NOW.setHours(0,0,0,0);
const NOW_T = NOW.getTime();

const HOLIDAYS = new Set([
  '2025-01-01','2025-01-13','2025-02-11','2025-02-23','2025-02-24',
  '2025-03-20','2025-04-29','2025-05-03','2025-05-04','2025-05-05',
  '2025-05-06','2025-07-21','2025-08-11','2025-09-15','2025-09-23',
  '2025-10-13','2025-11-03','2025-11-23','2025-11-24',
  '2026-01-01','2026-01-12','2026-02-11','2026-02-23','2026-03-20',
  '2026-04-29','2026-05-03','2026-05-04','2026-05-05','2026-05-06',
  '2026-07-20','2026-08-11','2026-09-21','2026-09-22','2026-09-23',
  '2026-10-12','2026-11-03','2026-11-23',
  '2027-01-01','2027-01-11','2027-02-11','2027-02-23','2027-03-21',
  '2027-03-22','2027-04-29','2027-05-03','2027-05-04','2027-05-05',
  '2027-07-19','2027-08-11','2027-09-20','2027-09-23','2027-10-11',
  '2027-11-03','2027-11-23'
]);
function isHol(d){
  const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');
  return HOLIDAYS.has(y+'-'+m+'-'+day);
}
function pd(s){if(!s||s==='null')return null;const d=new Date(s+'T00:00:00');return isNaN(d)?null:d;}
function fd(d){return d?(d.getMonth()+1)+'/'+d.getDate():'-';}
function fds(s){if(!s)return'';const p=s.split('-');if(p.length<3)return s;return parseInt(p[1])+'/'+parseInt(p[2]);}
function esc(s){if(!s)return'';return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function sc(s){
  if(!s)return'';
  if(s.startsWith('00'))return's00';if(s.startsWith('01')||s.startsWith('02')||s.startsWith('03'))return's01';
  if(s.startsWith('04')||s.startsWith('05'))return's04';if(s.startsWith('06')||s.startsWith('07'))return's06';
  if(s.startsWith('08'))return's08';if(s.startsWith('09'))return's09';if(s.startsWith('10'))return's10';
  if(s==='失注')return'sl';if(s==='ペンディング')return'sp';return'';
}
function stClass(s){
  if(!s)return'st00';
  if(s.startsWith('00'))return'st00';if(s.startsWith('01')||s.startsWith('02')||s.startsWith('03'))return'st01';
  if(s.startsWith('04')||s.startsWith('05'))return'st04';if(s.startsWith('06')||s.startsWith('07'))return'st06';
  if(s.startsWith('08'))return'st08';if(s.startsWith('09'))return'st09';return'st00';
}
function getNextEvent(r){
  const evs=[
    {f:'Naijibi__c',l:'内示'},{f:'TempSurveyDate__c',l:'仮現調'},{f:'SurveyDate__c',l:'本現調'},
    {f:'Field27__c',l:'納品'},{f:'KojiSekouyoteibi__c',l:'着工'},{f:'ScheduleOfBlackoutDates__c',l:'停電'},
    {f:'KojiKankobi__c',l:'完工検査'},{f:'Kankobi__c',l:'完工'},{f:'StartDate__c',l:'稼働開始'}
  ];
  let n=null;
  for(const e of evs){const d=pd(r[e.f]);if(d&&d>=NOW&&(!n||d<n.date))n={date:d,label:e.l};}
  return n;
}

// ===== Today Dashboard =====
function buildTodayDash(){
  // Use string-based date comparison to avoid timezone issues
  const todayStr = NOW.getFullYear()+'-'+String(NOW.getMonth()+1).padStart(2,'0')+'-'+String(NOW.getDate()).padStart(2,'0');
  const TMR = new Date(NOW); TMR.setDate(TMR.getDate()+1);
  const tmrStr = TMR.getFullYear()+'-'+String(TMR.getMonth()+1).padStart(2,'0')+'-'+String(TMR.getDate()).padStart(2,'0');

  const events=[
    {f:'TempSurveyDate__c', label:'仮現調'},
    {f:'SurveyDate__c',     label:'本現調'},
    {f:'Naijibi__c',        label:'内示'},
    {f:'Field27__c',        label:'納品'},
    {f:'ScheduleOfBlackoutDates__c', label:'停電'},
    {f:'KojiKankobi__c',   label:'完工検査'},
  ];

  const cats = ['仮現調','本現調','内示','納品','停電','完工検査',
    '着工予定（本日）','施工中',
    '開通予定（本日）','開通予定（明日）','本日の予定'];
  let todayItems = {};
  cats.forEach(c => { todayItems[c] = []; });

  // All date fields to check for "本日の予定"
  const allDateFields = [
    {f:'Naijibi__c',l:'内示'},{f:'TempSurveyDate__c',l:'仮現調'},{f:'SurveyDate__c',l:'本現調'},
    {f:'Field27__c',l:'納品'},{f:'KojiSekouyoteibi__c',l:'着工'},{f:'ScheduleOfBlackoutDates__c',l:'停電'},
    {f:'KojiKankobi__c',l:'完工検査'},{f:'Kankobi__c',l:'完工'},{f:'StartDate__c',l:'稼働開始'}
  ];

  let totalCount = 0;
  D.forEach(r => {
    const stg = r.StageName || '';
    events.forEach(e => {
      const v = r[e.f];
      if(v && v === todayStr){
        todayItems[e.label].push(r);
        totalCount++;
      }
    });
    const kojiStr = r.KojiSekouyoteibi__c || '';
    const kankoStr = r.Kankobi__c || '';
    if(kojiStr === todayStr && stg.startsWith('08')){
      todayItems['着工予定（本日）'].push(r);
      totalCount++;
    }
    if(kojiStr && kankoStr && todayStr > kojiStr && todayStr < kankoStr
       && (stg.startsWith('08') || stg.startsWith('09'))){
      todayItems['施工中'].push(r);
      totalCount++;
    }
    if(kankoStr && (stg.startsWith('08') || stg.startsWith('09'))){
      if(kankoStr === todayStr){
        todayItems['開通予定（本日）'].push(r);
        totalCount++;
      } else if(kankoStr === tmrStr){
        todayItems['開通予定（明日）'].push(r);
        totalCount++;
      }
    }
    // Check all date fields for today's date
    const todayLabels = [];
    allDateFields.forEach(df => {
      const v = r[df.f];
      if(v && v === todayStr) todayLabels.push(df.l);
    });
    if(todayLabels.length > 0){
      r._todayLabels = todayLabels;
      todayItems['本日の予定'].push(r);
      totalCount++;
    }
  });

  document.getElementById('todayCount').textContent = totalCount + '件';

  const grid = document.getElementById('dashGrid');
  let html = '';

  const displayOrder = [
    {label:'開通予定（本日）', icon:'★', icCls:'ic-start'},
    {label:'開通予定（明日）', icon:'☆', icCls:'ic-start-tmr'},
    {label:'着工予定（本日）', icon:'工', icCls:'ic-koji'},
    {label:'本現調', icon:'現', icCls:'ic-survey'},
    {label:'仮現調', icon:'仮', icCls:'ic-tmpsvy'},
    {label:'施工中', icon:'中', icCls:'ic-koji'},
    {label:'停電',   icon:'停', icCls:'ic-blackout'},
    {label:'完工検査', icon:'検', icCls:'ic-kanko'},
    {label:'納品',   icon:'納', icCls:'ic-delivery'},
    {label:'内示',   icon:'示', icCls:'ic-naiji'},
    {label:'本日の予定', icon:'今', icCls:'ic-updated'},
  ];

  let hasAny = false;
  displayOrder.forEach(e => {
    const items = todayItems[e.label];
    if(!items || items.length === 0) return;
    hasAny = true;
    const isTmr = e.label === '開通予定（明日）';
    const cardBorder = isTmr ? 'border:1px dashed #66bb6a;' : '';
    html += '<div class="dash-card" style="'+cardBorder+'">';
    html += '<h3><span class="icon '+e.icCls+'">'+e.icon+'</span>'+e.label+'<span style="color:#666;font-weight:400;font-size:11px;">('+items.length+'件)</span></h3>';
    html += '<ul>';
    items.forEach(r => {
      const pref = r.Prefecture || '';
      const st = r.StageName || '';
      const stc = stClass(st);
      const kankoD = pd(r.Kankobi__c);
      const kojiD = pd(r.KojiSekouyoteibi__c);
      html += '<li>';
      if(pref) html += '<span class="pref-tag">'+esc(pref)+'</span>';
      html += '<span class="opp-name" title="'+esc(r.Name)+'">'+esc(r.Name)+'</span>';
      if(e.label === '本日の予定' && r._todayLabels){
        html += '<span style="font-size:9px;color:#ff5722;margin-left:auto;white-space:nowrap;font-weight:600;">'+r._todayLabels.join(', ')+'</span>';
      } else if(e.label === '施工中' && kankoD){
        html += '<span style="font-size:9px;color:#2e7d32;margin-left:auto;white-space:nowrap;">完工:'+fd(kankoD)+'</span>';
      } else if(e.label.includes('着工') && kankoD){
        html += '<span style="font-size:9px;color:#2e7d32;margin-left:auto;white-space:nowrap;">完工:'+fd(kankoD)+'</span>';
      } else if(e.label.includes('開通') && kojiD){
        html += '<span style="font-size:9px;color:#e65100;margin-left:auto;white-space:nowrap;">着工:'+fd(kojiD)+'</span>';
      }
      if(st) html += '<span class="stage-tag '+stc+'">'+esc(st.substring(0,5))+'</span>';
      html += '</li>';
    });
    html += '</ul></div>';
  });

  if(!hasAny){
    html = '<div class="dash-empty">&#x2705; 本日の予定はありません</div>';
  }
  grid.innerHTML = html;
}

let dashOpen = true;
function toggleDash(){
  dashOpen = !dashOpen;
  document.getElementById('dashGrid').classList.toggle('dash-hidden', !dashOpen);
  document.getElementById('dashToggle').textContent = dashOpen ? '\u25BC たたむ' : '\u25B6 ひらく';
}

// ===== Filters =====
function populateFilters(){
  const prefSet=new Set(), ctSet=new Set(), cuSet=new Set();
  D.forEach(r=>{if(r.Prefecture)prefSet.add(r.Prefecture);if(r.ConstractType__c)ctSet.add(r.ConstractType__c);if(r.ConstUserName)cuSet.add(r.ConstUserName);});
  const pfSel=document.getElementById('pff');
  [...prefSet].sort().forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;pfSel.appendChild(o);});
  const ctPanel=document.getElementById('ctPanel');
  [...ctSet].sort().forEach(c=>{const lbl=document.createElement('label');lbl.innerHTML='<input type="checkbox" value="'+c+'" onchange="onCTypeChk()">'+c;ctPanel.appendChild(lbl);});
  const cuSel=document.getElementById('cuf');
  [...cuSet].sort((a,b)=>a.localeCompare(b,'ja')).forEach(u=>{const o=document.createElement('option');o.value=u;o.textContent=u;cuSel.appendChild(o);});
}

let sortCol='',sortDir='asc';
function toggleSort(col){
  if(sortCol===col){sortDir=sortDir==='asc'?'desc':'asc';}
  else{sortCol=col;sortDir='asc';}
  render();
}

// === Multi-select stage filter ===
let selStages=new Set(); // empty = all
function onStageChk(){
  const cbs=document.querySelectorAll('#sfPanel input[type=checkbox]');
  selStages.clear();
  cbs.forEach(cb=>{if(cb.checked)selStages.add(cb.value);});
  const btn=document.getElementById('sfBtn');
  if(selStages.size===0) btn.textContent='全て';
  else if(selStages.size<=3) btn.textContent=[...selStages].map(v=>v+'_').join(', ').replace(/_,/g,', ').replace(/_$/,'');
  else btn.textContent=selStages.size+'件選択中';
  render();
}
// === Multi-select business type filter ===
let selCTypes=new Set();
function onCTypeChk(){
  const cbs=document.querySelectorAll('#ctPanel input[type=checkbox]');
  selCTypes.clear();
  cbs.forEach(cb=>{if(cb.checked)selCTypes.add(cb.value);});
  const btn=document.getElementById('ctBtn');
  if(selCTypes.size===0) btn.textContent='全て';
  else if(selCTypes.size<=2) btn.textContent=[...selCTypes].join(', ');
  else btn.textContent=selCTypes.size+'件選択中';
  render();
}
// Close dropdowns on outside click
document.addEventListener('click',e=>{
  const w=document.getElementById('sfWrap');
  if(w&&!w.contains(e.target))document.getElementById('sfPanel').classList.remove('open');
  const w2=document.getElementById('ctWrap');
  if(w2&&!w2.contains(e.target))document.getElementById('ctPanel').classList.remove('open');
});

// === Event type legend filter ===
const activeEvs=new Set(); // empty = no filter (show all)
const evFieldMap={
  naiji:'Naijibi__c', tmpsvy:'TempSurveyDate__c', survey:'SurveyDate__c',
  delivery:'Field27__c', koji:'KojiSekouyoteibi__c', blackout:'ScheduleOfBlackoutDates__c',
  kanko:'KojiKankobi__c', start:'StartDate__c'
};
function toggleEv(el){
  const ev=el.dataset.ev;
  if(activeEvs.has(ev)){activeEvs.delete(ev);el.classList.remove('on');el.classList.add('off');}
  else{activeEvs.add(ev);el.classList.add('on');el.classList.remove('off');}
  // If any filter is active, dim inactive ones; if none active, reset all
  const allFlt=document.querySelectorAll('.legend-item.flt');
  if(activeEvs.size===0) allFlt.forEach(f=>{f.classList.remove('on','off');});
  else allFlt.forEach(f=>{if(!activeEvs.has(f.dataset.ev))f.classList.add('off');else f.classList.remove('off');});
  render();
}
function hasActiveEvent(r){
  // koji is special: check range (着工〜完工)
  for(const ev of activeEvs){
    if(ev==='koji'){
      if(r.KojiSekouyoteibi__c||r.Kankobi__c)return true;
    } else {
      const fld=evFieldMap[ev];
      if(fld&&r[fld])return true;
    }
  }
  return false;
}

function render(){
  const si=document.getElementById('si').value.toLowerCase();
  const pf=document.getElementById('pf').value;
  const pfv=document.getElementById('pff').value;
  const cuv=document.getElementById('cuf').value;

  let f=D.filter(r=>{
    if(si&&!r.Name.toLowerCase().includes(si))return false;
    const s=r.StageName||'';
    if(selStages.size>0){let match=false;for(const st of selStages){if(s.startsWith(st)){match=true;break;}}if(!match)return false;}
    if(pfv!=='all'&&(r.Prefecture||'')!==pfv)return false;
    if(selCTypes.size>0&&!selCTypes.has(r.ConstractType__c||''))return false;
    if(cuv==='none'&&r.ConstUserName)return false;
    if(cuv!=='all'&&cuv!=='none'&&(r.ConstUserName||'')!==cuv)return false;
    if(activeEvs.size>0&&!hasActiveEvent(r))return false;
    return true;
  });

  if(sortCol){
    f.sort((a,b)=>{
      let va,vb;
      if(sortCol==='name'){va=a.Name||'';vb=b.Name||'';}
      else if(sortCol==='pref'){va=a.Prefecture||'\uff9d';vb=b.Prefecture||'\uff9d';}
      else if(sortCol==='type'){va=a.ConstractType__c||'\uff9d';vb=b.ConstractType__c||'\uff9d';}
      else if(sortCol==='tmpsvy'){va=a.TempSurveyDate__c||'9999';vb=b.TempSurveyDate__c||'9999';}
      else if(sortCol==='survey'){va=a.SurveyDate__c||'9999';vb=b.SurveyDate__c||'9999';}
      else if(sortCol==='svyck'){va=a.SurveyKakutei__c?0:1;vb=b.SurveyKakutei__c?0:1;return sortDir==='asc'?va-vb:vb-va;}
      else if(sortCol==='const'){va=a.ConstUserName||'\uff9d';vb=b.ConstUserName||'\uff9d';}
      else if(sortCol==='stage'){va=a.StageName||'';vb=b.StageName||'';}
      else if(sortCol==='koji'){va=a.KojiSekouyoteibi__c||'9999';vb=b.KojiSekouyoteibi__c||'9999';}
      else if(sortCol==='kojick'){va=a.KojiSekouKakuteibi__c?0:1;vb=b.KojiSekouKakuteibi__c?0:1;return sortDir==='asc'?va-vb:vb-va;}
      else if(sortCol==='next'){
        const ea=getNextEvent(a),eb=getNextEvent(b);
        va=ea?ea.date.getTime():9999999999999;
        vb=eb?eb.date.getTime():9999999999999;
        return sortDir==='asc'?va-vb:vb-va;
      }
      else{va='';vb='';}
      if(typeof va==='string'){const c=va.localeCompare(vb,'ja');return sortDir==='asc'?c:-c;}
      return sortDir==='asc'?va-vb:vb-va;
    });
  }else{
    f.sort((a,b)=>{
      const da=pd(a.KojiSekouyoteibi__c)||pd(a.Kankobi__c)||new Date('2099-01-01');
      const db=pd(b.KojiSekouyoteibi__c)||pd(b.Kankobi__c)||new Date('2099-01-01');
      return da-db;
    });
  }

  document.getElementById('fc').textContent=f.length+'件 / '+D.length+'件中';

  let sd,ed;
  if(pf==='all'){sd=new Date('2025-01-01');ed=new Date('2027-06-30');}
  else{
    const m=parseInt(pf);
    sd=new Date(NOW.getFullYear(),NOW.getMonth(),1);
    ed=new Date(NOW);ed.setMonth(ed.getMonth()+m+1);ed.setDate(0);
  }

  let mons=[],cm=-1,md=0,cd=new Date(sd);
  while(cd<=ed){const m=cd.getFullYear()*100+cd.getMonth();if(m!==cm){if(cm!==-1)mons.push({m:cm,d:md});cm=m;md=0;}md++;cd.setDate(cd.getDate()+1);}
  if(md>0)mons.push({m:cm,d:md});

  const scs=['name','pref','type','tmpsvy','survey','svyck','const','stage','koji','kojick','next'];
  const scl=['商談名','県','区分','仮現調日','本現調日','確定','施工担当','ステータス','着工日','確定','次の予定'];
  const scc=['col-name','col-pref','col-type','col-tmpsvy','col-survey','col-svyck','col-const','col-stage','col-koji','col-kojick','col-next'];
  let mr='<tr>';
  for(let i=0;i<scs.length;i++){
    let cls=scc[i]+' sortable';
    if(sortCol===scs[i])cls+=' sort-'+(sortDir==='asc'?'asc':'desc');
    mr+='<th class="'+cls+'" rowspan="2" style="font-size:11px;cursor:pointer;" onclick="toggleSort(\''+scs[i]+'\')">'+scl[i]+'</th>';
  }
  mons.forEach(m=>{const y=Math.floor(m.m/100),mn=(m.m%100)+1;mr+='<th class="mh" colspan="'+m.d+'">'+y+'/'+mn+'</th>';});
  mr+='</tr>';

  let dr='<tr>';cd=new Date(sd);
  while(cd<=ed){
    const dw=cd.getDay(),hol=isHol(cd),isSat=(dw===6),isSun=(dw===0),isTl=(cd.getTime()===NOW_T),dn=cd.getDate();
    let cls='dc',hc='';
    if(hol||isSun){cls+=' sun';hc=' sun-head';}else if(isSat){cls+=' sat';hc=' sat-head';}
    if(isTl)cls+=' tl';
    dr+='<th class="'+cls+hc+'" title="'+(cd.getMonth()+1)+'/'+dn+(hol?' (祝)':'')+'">'+dn+'</th>';
    cd.setDate(cd.getDate()+1);
  }
  dr+='</tr>';

  let tb='';
  f.forEach(r=>{
    const koji=pd(r.KojiSekouyoteibi__c),kanko=pd(r.Kankobi__c),kojiK=pd(r.KojiKankobi__c);
    const stD=pd(r.StartDate__c),bl=pd(r.ScheduleOfBlackoutDates__c);
    const ts=pd(r.TempSurveyDate__c),sv=pd(r.SurveyDate__c);
    const dl=pd(r.Field27__c),nj=pd(r.Naijibi__c);
    const kk=r.KojiSekouKakuteibi__c===true||r.KojiSekouKakuteibi__c==='true';

    const nxEv=getNextEvent(r);
    let nxH='',nxC='col-next';
    if(nxEv){nxC+=' nx-wait';nxH=nxEv.label+'待ち '+fd(nxEv.date);}
    else{nxC+=' nx-alert';nxH='&#x26A0; 予定なし';}

    const pref=r.Prefecture||'-';
    const ctype=r.ConstractType__c||'-';
    const constName=r.ConstUserName||'';
    const constCls=constName?'has-user':'no-user';
    const tmpSvyStr=r.TempSurveyDate__c||'';
    const svyStr=r.SurveyDate__c||'';

    tb+='<tr>';
    tb+='<td class="col-name" title="'+esc(r.Name)+'">'+esc(r.Name)+'</td>';
    tb+='<td class="col-pref">'+esc(pref)+'</td>';
    tb+='<td class="col-type">'+esc(ctype)+'</td>';
    tb+='<td class="col-tmpsvy '+(tmpSvyStr?'date-val':'date-empty')+'" title="'+(tmpSvyStr||'未設定')+'">'+(tmpSvyStr?fds(tmpSvyStr):'-')+'</td>';
    tb+='<td class="col-survey '+(svyStr?'date-val':'date-empty')+'" title="'+(svyStr||'未設定')+'">'+(svyStr?fds(svyStr):'-')+'</td>';
    const svyKk=r.SurveyKakutei__c===true||r.SurveyKakutei__c==='true';
    tb+='<td class="col-svyck '+(svyKk?'ck-ok':'ck-ng')+'" title="'+(svyKk?'確定':'未確定')+'">'+(svyKk?'&#10003;':'&#x2015;')+'</td>';
    tb+='<td class="col-const '+constCls+'" title="'+esc(constName||'未設定')+'">'+(constName?esc(constName):'-')+'</td>';
    tb+='<td class="col-stage '+sc(r.StageName)+'">'+(r.StageName||'')+'</td>';
    const kojiStr=r.KojiSekouyoteibi__c||'';
    tb+='<td class="col-koji '+(kojiStr?'date-val':'date-empty')+'" title="'+(kojiStr||'未設定')+'">'+(kojiStr?fds(kojiStr):'-')+'</td>';
    tb+='<td class="col-kojick '+(kk?'ck-ok':'ck-ng')+'" title="'+(kk?'確定':'未確定')+'">'+(kk?'&#10003;':'&#x2015;')+'</td>';
    tb+='<td class="'+nxC+'" title="'+(nxEv?nxEv.label+'待ち '+fd(nxEv.date):'予定なし')+'">'+nxH+'</td>';

    cd=new Date(sd);
    while(cd<=ed){
      const dw=cd.getDay(),hol=isHol(cd),isSat=(dw===6),isSun=(dw===0),isTl=(cd.getTime()===NOW_T),t=cd.getTime();
      let cls='dc';
      if(hol||isSun)cls+=' sun';else if(isSat)cls+=' sat';
      if(isTl)cls+=' tl';
      let bg='',tt='';
      if(nj&&t===nj.getTime()){bg='background:#607d8b;';tt='内示日:'+fd(nj);}
      if(ts&&t===ts.getTime()){bg='background:#b3e5fc;border:2px solid #4fc3f7;';tt='仮現調:'+fd(ts);}
      if(sv&&t===sv.getTime()){bg='background:#4fc3f7;';tt='本現調:'+fd(sv);}
      if(dl&&t===dl.getTime()){bg='background:#795548;';tt='納品:'+fd(dl);}
      if(koji&&kanko&&t>=koji.getTime()&&t<=kanko.getTime()){
        bg=kk?'background:#ff9800;':'background:#ffe0b2;';
        tt='着工:'+fd(koji)+' 〜 完工:'+fd(kanko)+(kk?' (確定)':' (予定)');
      }else if(koji&&!kanko&&t===koji.getTime()){
        bg='background:#ffe0b2;border-left:3px solid #ff9800;';tt='着工(予定):'+fd(koji);
      }
      if(bl&&t===bl.getTime()){bg='background:#f44336;';tt='停電日:'+fd(bl);}
      if(kojiK&&t===kojiK.getTime()){bg='background:#ab47bc;';tt='完工検査:'+fd(kojiK);}
      if(stD&&t===stD.getTime()){bg='background:#4caf50;';tt='稼働開始:'+fd(stD);}
      const st=bg?' style="'+bg+'"':'';
      const ttt=tt?' title="'+tt+'"':'';
      tb+='<td class="'+cls+'"'+st+ttt+'></td>';
      cd.setDate(cd.getDate()+1);
    }
    tb+='</tr>';
  });

  document.getElementById('gt').innerHTML='<thead>'+mr+dr+'</thead><tbody>'+tb+'</tbody>';

  setTimeout(()=>{
    const tds=document.querySelectorAll('.tl');
    if(tds.length>0)tds[0].scrollIntoView({inline:'center',block:'nearest'});
  },100);
}

// ===== Filter reset =====
function resetFilters(){
  const pfSel=document.getElementById('pff');
  while(pfSel.options.length>1) pfSel.remove(1);
  document.getElementById('ctPanel').innerHTML='';
  const cuSel=document.getElementById('cuf');
  while(cuSel.options.length>2) cuSel.remove(2);
  selCTypes.clear();
  document.getElementById('ctBtn').textContent='全て';
}

// ===== UI更新処理 =====
let lastKnownUpdate='';
let initialLoadDone=false;

function applyDataToUI(val){
  if(!val||!val.pph_data) return;
  D=Array.isArray(val.pph_data)?val.pph_data:Object.values(val.pph_data);
  document.getElementById('tc').textContent=D.length;
  const meta=val.metadata||{};
  if(meta.lastUpdated){
    document.getElementById('ut').textContent=meta.lastUpdated;
  } else {
    document.getElementById('ut').textContent=new Date().toLocaleString('ja-JP');
  }
  resetFilters();
  populateFilters();
  buildTodayDash();
  render();
}

// ===== リアルタイムリスナー (ガイド Section 5 — onSnapshot相当) =====
// Firebase Realtime Database の onValue は Firestore の onSnapshot と同じ役割。
// データが変わるたびに callback が全クライアントで自動発火する。
let unsubscribe=null;

function subscribeToData(callback){
  const rootRef=fbDb.ref('/');
  rootRef.on('value',function(snapshot){
    const val=snapshot.val();
    callback(val);
  },function(err){
    console.error('Firebase listener error:',err);
  });
  // 解除関数を返す（ガイド Section 6 の cleanup パターン）
  return function(){ rootRef.off('value'); };
}

// ===== 同期通知 =====
function showSyncNotice(){
  let el=document.getElementById('syncNotice');
  if(!el){
    el=document.createElement('div');
    el.id='syncNotice';
    el.style.cssText='position:fixed;bottom:20px;right:20px;background:#1a237e;color:#fff;padding:10px 18px;border-radius:8px;font-size:13px;z-index:9999;opacity:0;transition:opacity 0.3s;box-shadow:0 2px 12px rgba(0,0,0,0.3);';
    document.body.appendChild(el);
  }
  el.textContent='\u2714 \u30c7\u30fc\u30bf\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f';
  el.style.opacity='1';
  setTimeout(function(){el.style.opacity='0';},3000);
}

// ===== 手動リフレッシュ（ボタン） =====
function refreshData(){
  const btn=document.getElementById('refreshBtn');
  btn.disabled=true;
  btn.innerHTML='<span class="spin">&#x21BB;</span> 更新中...';
  // リスナー再接続で最新データを強制取得
  if(unsubscribe){unsubscribe();unsubscribe=null;}
  unsubscribe=subscribeToData(function(val){
    if(!val||!val.pph_data){
      btn.innerHTML='&#x26A0; 失敗';
      setTimeout(function(){btn.innerHTML='&#x21BB; データ更新';btn.disabled=false;},3000);
      return;
    }
    applyDataToUI(val);
    const newTs=(val.metadata&&val.metadata.lastUpdated)||'';
    lastKnownUpdate=newTs;
    btn.innerHTML='&#x2713; 更新完了';
    setTimeout(function(){btn.innerHTML='&#x21BB; データ更新';btn.disabled=false;},2000);
  });
}

// ===== Init (ガイド Section 6 — 起動時フロー) =====
// リスナー登録 → データ受信 → UI反映 → 以降は自動同期
function initApp(){
  unsubscribe=subscribeToData(function(val){
    if(!val||!val.pph_data){
      if(!initialLoadDone){
        document.getElementById('loading-overlay').innerHTML=
          '<p style="color:#c62828;font-size:16px;">&#x26A0; エラー: データが空です。</p>'+
          '<p style="margin-top:8px;font-size:13px;color:#666;">ページを再読み込みするか、管理者に連絡してください。</p>';
      }
      return;
    }
    applyDataToUI(val);
    const newTs=(val.metadata&&val.metadata.lastUpdated)||'';
    if(initialLoadDone&&newTs!==lastKnownUpdate){
      // 他ユーザーによる更新を検知 → トースト通知
      showSyncNotice();
    }
    lastKnownUpdate=newTs;
    if(!initialLoadDone){
      initialLoadDone=true;
      document.getElementById('loading-overlay').style.display='none';
    }
  });
}

initApp();
</script>
</body>
</html>